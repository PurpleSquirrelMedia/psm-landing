<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Backlot - Purple Squirrel Media</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            overflow: hidden;
            background: #0a0612;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        #canvas {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1;
        }

        .vignette {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 99;
            background: radial-gradient(ellipse at center, transparent 0%, transparent 60%, rgba(0,0,0,0.5) 100%);
        }

        /* Navigation Menu */
        .nav-toggle {
            position: fixed;
            top: 1.5rem;
            left: 1.5rem;
            z-index: 500;
            width: 50px;
            height: 50px;
            background: rgba(139, 92, 246, 0.2);
            border: 2px solid rgba(139, 92, 246, 0.5);
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        .nav-toggle:hover {
            background: rgba(139, 92, 246, 0.4);
            transform: scale(1.05);
        }
        .nav-toggle span {
            display: block;
            width: 22px;
            height: 2px;
            background: white;
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        .nav-toggle.active span:nth-child(1) { transform: rotate(45deg) translate(5px, 5px); }
        .nav-toggle.active span:nth-child(2) { opacity: 0; }
        .nav-toggle.active span:nth-child(3) { transform: rotate(-45deg) translate(5px, -5px); }

        .nav-menu {
            position: fixed;
            top: 0;
            left: -320px;
            width: 300px;
            height: 100vh;
            background: rgba(10, 6, 18, 0.95);
            backdrop-filter: blur(20px);
            z-index: 450;
            padding: 5rem 2rem 2rem;
            transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            border-right: 1px solid rgba(139, 92, 246, 0.3);
        }
        .nav-menu.open { left: 0; }

        .nav-section {
            margin-bottom: 2rem;
        }
        .nav-section-title {
            font-size: 0.7rem;
            color: rgba(139, 92, 246, 0.8);
            text-transform: uppercase;
            letter-spacing: 0.2em;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        }
        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            font-size: 0.9rem;
            border-radius: 8px;
            transition: all 0.2s ease;
            margin-bottom: 0.25rem;
        }
        .nav-link:hover {
            background: rgba(139, 92, 246, 0.2);
            color: white;
            transform: translateX(5px);
        }
        .nav-link .icon {
            font-size: 1.1rem;
            width: 24px;
            text-align: center;
        }
        .nav-link.active {
            background: rgba(139, 92, 246, 0.3);
            color: #a78bfa;
        }

        .nav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 400;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .nav-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .controls-hint {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 200;
            text-align: center;
            opacity: 0;
            animation: fadeIn 2s ease 1s forwards;
        }

        .controls-hint h3 {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.8);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
        }

        .key-hints {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .key {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: rgba(255,255,255,0.5);
        }

        .key span {
            background: rgba(139, 92, 246, 0.3);
            border: 1px solid rgba(139, 92, 246, 0.5);
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-family: monospace;
            font-weight: bold;
        }

        .logo-overlay {
            position: fixed;
            top: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 200;
            text-align: center;
            opacity: 0;
            animation: fadeIn 1.5s ease 0.5s forwards;
        }

        .logo-overlay h1 {
            font-size: clamp(1.8rem, 5vw, 3.5rem);
            font-weight: 900;
            background: linear-gradient(180deg, #a78bfa 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 0.05em;
            text-shadow: 0 0 30px rgba(139, 92, 246, 0.3);
        }

        .logo-overlay p {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.6);
            letter-spacing: 0.25em;
            text-transform: uppercase;
            margin-top: 0.5rem;
        }

        .score-panel {
            position: fixed;
            top: 5rem;
            left: 2rem;
            z-index: 200;
            opacity: 0;
            animation: fadeInLeft 2s ease 1.5s forwards;
        }

        @keyframes fadeInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .score-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            background: rgba(0,0,0,0.6);
            padding: 0.5rem 1rem;
            border-radius: 25px;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .score-icon { font-size: 1.2rem; }
        .score-value { font-size: 1rem; font-weight: bold; color: white; }
        .score-label {
            font-size: 0.65rem;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .speedometer {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 200;
            width: 100px;
            height: 100px;
            opacity: 0;
            animation: fadeIn 2s ease 1.5s forwards;
        }

        .speed-ring { fill: none; stroke: rgba(139, 92, 246, 0.3); stroke-width: 4; }
        .speed-progress {
            fill: none;
            stroke: url(#speedGradient);
            stroke-width: 4;
            stroke-linecap: round;
            stroke-dasharray: 251;
            stroke-dashoffset: 251;
            transform: rotate(-90deg);
            transform-origin: center;
            transition: stroke-dashoffset 0.1s;
        }
        .speed-value { fill: white; font-size: 1.2rem; font-weight: bold; text-anchor: middle; }
        .speed-label { fill: rgba(255,255,255,0.5); font-size: 0.5rem; text-anchor: middle; text-transform: uppercase; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .minimap {
            position: fixed;
            top: 2rem;
            right: 2rem;
            width: 120px;
            height: 120px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(139, 92, 246, 0.4);
            border-radius: 10px;
            z-index: 200;
            opacity: 0;
            animation: fadeInRight 2s ease 2s forwards;
        }

        @keyframes fadeInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        #minimap-canvas { width: 100%; height: 100%; border-radius: 8px; }

        .boost-indicator {
            position: fixed;
            bottom: 8rem;
            right: 2rem;
            z-index: 200;
            opacity: 0;
            animation: fadeInRight 2s ease 1.8s forwards;
        }

        .boost-bar {
            width: 100px;
            height: 8px;
            background: rgba(139, 92, 246, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .boost-fill {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #06b6d4);
            border-radius: 4px;
            transition: width 0.1s;
        }

        .boost-label {
            font-size: 0.6rem;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.3rem;
        }

        .pickup-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 300;
            font-size: 2rem;
            font-weight: bold;
            color: #a78bfa;
            text-shadow: 0 0 20px rgba(139, 92, 246, 0.8);
            opacity: 0;
            pointer-events: none;
        }

        .pickup-notification.show { animation: pickupPop 1s ease forwards; }

        @keyframes pickupPop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -80%) scale(1); }
        }

        .objective-panel {
            position: fixed;
            bottom: 6rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 200;
            text-align: center;
            opacity: 0;
            animation: fadeIn 2s ease 2.5s forwards;
        }

        .objective-text {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.6);
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }

        .objective-progress {
            margin-top: 0.5rem;
            width: 200px;
            height: 4px;
            background: rgba(139, 92, 246, 0.2);
            border-radius: 2px;
            overflow: hidden;
        }

        .objective-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #06b6d4);
            border-radius: 2px;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>

    <div class="vignette"></div>

    <!-- Navigation Menu -->
    <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation">
        <span></span>
        <span></span>
        <span></span>
    </button>
    <div class="nav-overlay" id="navOverlay"></div>
    <nav class="nav-menu" id="navMenu">
        <div class="nav-section">
            <div class="nav-section-title">Watch</div>
            <a href="../watch.html" class="nav-link"><span class="icon">üé¨</span> Watch Now</a>
            <a href="../free-tv.html" class="nav-link"><span class="icon">üì∫</span> Free TV</a>
            <a href="../app.html" class="nav-link"><span class="icon">üì±</span> Streaming App</a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">Listen</div>
            <a href="../radio.html" class="nav-link"><span class="icon">üìª</span> Radio</a>
            <a href="../radio-submit.html" class="nav-link"><span class="icon">üéµ</span> Submit Music</a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">Company</div>
            <a href="../about.html" class="nav-link"><span class="icon">üêøÔ∏è</span> About Us</a>
            <a href="../blog.html" class="nav-link"><span class="icon">üìù</span> Blog</a>
            <a href="../plans.html" class="nav-link"><span class="icon">üíé</span> Plans & Pricing</a>
            <a href="../advertise.html" class="nav-link"><span class="icon">üì¢</span> Advertise</a>
            <a href="../contact.html" class="nav-link"><span class="icon">‚úâÔ∏è</span> Contact</a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">Account</div>
            <a href="../login.html" class="nav-link"><span class="icon">üîê</span> Sign In</a>
            <a href="../dashboard.html" class="nav-link"><span class="icon">üìä</span> Dashboard</a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">Demos</div>
            <a href="interactive-cinema.html" class="nav-link active"><span class="icon">üéÆ</span> Studio Backlot</a>
            <a href="2-cinema-hero.html" class="nav-link"><span class="icon">üé•</span> Cinema Hero</a>
            <a href="theme-streaming.html" class="nav-link"><span class="icon">üì°</span> Streaming</a>
            <a href="theme-tv.html" class="nav-link"><span class="icon">üì∫</span> TV Theme</a>
            <a href="theme-movie.html" class="nav-link"><span class="icon">üéûÔ∏è</span> Movie Theme</a>
            <a href="1-galaxy-particles.html" class="nav-link"><span class="icon">üåå</span> Galaxy</a>
            <a href="5-liquid-blob.html" class="nav-link"><span class="icon">üíß</span> Liquid Blob</a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">Legal</div>
            <a href="../privacy.html" class="nav-link"><span class="icon">üîí</span> Privacy</a>
            <a href="../terms.html" class="nav-link"><span class="icon">üìú</span> Terms</a>
            <a href="../dmca.html" class="nav-link"><span class="icon">¬©Ô∏è</span> DMCA</a>
        </div>
    </nav>

    <div class="logo-overlay">
        <h1>PURPLE SQUIRREL STUDIOS</h1>
        <p>Explore the Backlot</p>
    </div>

    <div class="score-panel">
        <div class="score-item">
            <span class="score-icon">‚≠ê</span>
            <div>
                <div class="score-value" id="starsCollected">0 / 8</div>
                <div class="score-label">Stars</div>
            </div>
        </div>
        <div class="score-item">
            <span class="score-icon">üèÜ</span>
            <div>
                <div class="score-value" id="trophiesCollected">0 / 4</div>
                <div class="score-label">Oscars</div>
            </div>
        </div>
    </div>

    <div class="controls-hint">
        <h3>Studio Tour Cart</h3>
        <div class="key-hints">
            <div class="key"><span>W</span> Forward</div>
            <div class="key"><span>S</span> Brake</div>
            <div class="key"><span>A</span><span>D</span> Steer</div>
            <div class="key"><span>SPACE</span> Turbo</div>
            <div class="key"><span>R</span> Reset</div>
        </div>
    </div>

    <div class="objective-panel">
        <div class="objective-text">Explore the studio lot!</div>
        <div class="objective-progress">
            <div class="objective-fill" id="objectiveFill" style="width: 0%"></div>
        </div>
    </div>

    <svg class="speedometer" viewBox="0 0 100 100">
        <defs>
            <linearGradient id="speedGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#8b5cf6"/>
                <stop offset="100%" style="stop-color:#06b6d4"/>
            </linearGradient>
        </defs>
        <circle class="speed-ring" cx="50" cy="50" r="40"/>
        <circle class="speed-progress" id="speedProgress" cx="50" cy="50" r="40"/>
        <text class="speed-value" id="speedValue" x="50" y="52">0</text>
        <text class="speed-label" x="50" y="65">MPH</text>
    </svg>

    <div class="boost-indicator">
        <div class="boost-label">Turbo</div>
        <div class="boost-bar">
            <div class="boost-fill" id="boostFill"></div>
        </div>
    </div>

    <div class="minimap">
        <canvas id="minimap-canvas"></canvas>
    </div>

    <div class="pickup-notification" id="pickupNotification">+1 Star!</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const canvas = document.getElementById('canvas');
        const renderer = new THREE.WebGLRenderer({ canvas, antialias: false, powerPreference: 'high-performance' });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(1); // Force pixel ratio 1 for performance
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.BasicShadowMap; // Faster shadows
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.2;

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0612);
        scene.fog = new THREE.Fog(0x0a0612, 40, 120);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 200);
        const cameraOffset = new THREE.Vector3(0, 5, 10);
        const cameraLookOffset = new THREE.Vector3(0, 1, 0);

        const gameState = { starsCollected: 0, totalStars: 8, trophiesCollected: 0, totalTrophies: 4 };

        // Simple lighting - optimized
        const ambientLight = new THREE.AmbientLight(0x332244, 0.6);
        scene.add(ambientLight);

        const keyLight = new THREE.DirectionalLight(0x8866ff, 1.2);
        keyLight.position.set(30, 40, 20);
        keyLight.castShadow = true;
        keyLight.shadow.mapSize.width = 1024;
        keyLight.shadow.mapSize.height = 1024;
        keyLight.shadow.camera.near = 1;
        keyLight.shadow.camera.far = 100;
        keyLight.shadow.camera.left = -60;
        keyLight.shadow.camera.right = 60;
        keyLight.shadow.camera.top = 60;
        keyLight.shadow.camera.bottom = -60;
        scene.add(keyLight);

        // Ground
        const groundGeom = new THREE.PlaneGeometry(150, 150);
        const groundMat = new THREE.MeshLambertMaterial({ color: 0x1a1520 });
        const ground = new THREE.Mesh(groundGeom, groundMat);
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);

        // Simple road markings
        const roadMat = new THREE.MeshBasicMaterial({ color: 0x8b5cf6, transparent: true, opacity: 0.3 });
        const roadH = new THREE.Mesh(new THREE.PlaneGeometry(150, 6), roadMat);
        roadH.rotation.x = -Math.PI / 2;
        roadH.position.y = 0.01;
        scene.add(roadH);
        const roadV = new THREE.Mesh(new THREE.PlaneGeometry(6, 150), roadMat);
        roadV.rotation.x = -Math.PI / 2;
        roadV.position.y = 0.01;
        scene.add(roadV);

        // ========== PURPLE STUDIO CART (Player) ==========
        const cartGroup = new THREE.Group();

        const cartMat = new THREE.MeshLambertMaterial({ color: 0x8b5cf6 });
        const cartBody = new THREE.Mesh(new THREE.BoxGeometry(2.5, 0.8, 4), cartMat);
        cartBody.position.y = 0.8;
        cartBody.castShadow = true;
        cartGroup.add(cartBody);

        const roofMat = new THREE.MeshLambertMaterial({ color: 0x222222 });
        const roof = new THREE.Mesh(new THREE.BoxGeometry(2.6, 0.1, 3.5), roofMat);
        roof.position.set(0, 2, -0.2);
        cartGroup.add(roof);

        // Wheels - simplified
        const wheelMat = new THREE.MeshLambertMaterial({ color: 0x111111 });
        const wheelGeom = new THREE.CylinderGeometry(0.35, 0.35, 0.2, 8);
        const wheels = [];
        [[-1.1, -1.3], [1.1, -1.3], [-1.1, 1.3], [1.1, 1.3]].forEach(([x, z]) => {
            const wheel = new THREE.Mesh(wheelGeom, wheelMat);
            wheel.rotation.z = Math.PI / 2;
            wheel.position.set(x, 0.35, z);
            cartGroup.add(wheel);
            wheels.push(wheel);
        });

        // Headlights
        const headlightMat = new THREE.MeshBasicMaterial({ color: 0xffffff });
        [-0.8, 0.8].forEach(x => {
            const headlight = new THREE.Mesh(new THREE.SphereGeometry(0.12, 6, 6), headlightMat);
            headlight.position.set(x, 0.8, -2);
            cartGroup.add(headlight);
        });

        // Purple glow under cart
        const glowLight = new THREE.PointLight(0x8b5cf6, 1, 10);
        glowLight.position.set(0, 0.3, 0);
        cartGroup.add(glowLight);

        scene.add(cartGroup);

        // ========== WATER TOWER ==========
        const towerGroup = new THREE.Group();
        const legMat = new THREE.MeshLambertMaterial({ color: 0x444444 });
        for (let i = 0; i < 4; i++) {
            const angle = (i / 4) * Math.PI * 2 + Math.PI / 4;
            const leg = new THREE.Mesh(new THREE.CylinderGeometry(0.25, 0.35, 12, 6), legMat);
            leg.position.set(Math.cos(angle) * 3, 6, Math.sin(angle) * 3);
            towerGroup.add(leg);
        }
        const tankMat = new THREE.MeshLambertMaterial({ color: 0x1a2a4c });
        const tank = new THREE.Mesh(new THREE.CylinderGeometry(4, 4, 6, 12), tankMat);
        tank.position.y = 15;
        tank.castShadow = true;
        towerGroup.add(tank);
        const cone = new THREE.Mesh(new THREE.ConeGeometry(4.2, 2.5, 12), tankMat);
        cone.position.y = 19.5;
        towerGroup.add(cone);
        // Purple stripe
        const stripeMat = new THREE.MeshBasicMaterial({ color: 0x8b5cf6 });
        const stripe = new THREE.Mesh(new THREE.CylinderGeometry(4.1, 4.1, 1.5, 12, 1, true), stripeMat);
        stripe.position.y = 15;
        towerGroup.add(stripe);
        towerGroup.position.set(-50, 0, -50);
        scene.add(towerGroup);

        // ========== SOUND STAGES (Simplified) ==========
        function createSoundStage(x, z, rotY = 0) {
            const group = new THREE.Group();
            const mat = new THREE.MeshLambertMaterial({ color: 0x3a3040 });
            const building = new THREE.Mesh(new THREE.BoxGeometry(20, 14, 30), mat);
            building.position.y = 7;
            building.castShadow = true;
            building.receiveShadow = true;
            group.add(building);
            // Door
            const doorMat = new THREE.MeshLambertMaterial({ color: 0x222222 });
            const door = new THREE.Mesh(new THREE.BoxGeometry(8, 10, 0.3), doorMat);
            door.position.set(0, 5, -15.1);
            group.add(door);
            // Number circle
            const circleMat = new THREE.MeshBasicMaterial({ color: 0x8b5cf6 });
            const circle = new THREE.Mesh(new THREE.CircleGeometry(1.2, 12), circleMat);
            circle.position.set(7, 11, -15.1);
            group.add(circle);
            group.position.set(x, 0, z);
            group.rotation.y = rotY;
            return group;
        }
        scene.add(createSoundStage(-45, 25, 0));
        scene.add(createSoundStage(45, 25, Math.PI));
        scene.add(createSoundStage(-45, -25, 0));
        scene.add(createSoundStage(45, -25, Math.PI));

        // ========== WESTERN FACADES (Simplified) ==========
        function createWesternBuilding(x) {
            const group = new THREE.Group();
            const mat = new THREE.MeshLambertMaterial({ color: 0x6b5545 });
            const facade = new THREE.Mesh(new THREE.BoxGeometry(8, 9, 1), mat);
            facade.position.y = 4.5;
            facade.castShadow = true;
            group.add(facade);
            // False front
            const top = new THREE.Mesh(new THREE.BoxGeometry(8, 2, 0.8), mat);
            top.position.y = 10;
            group.add(top);
            group.position.set(x, 0, 60);
            return group;
        }
        for (let i = 0; i < 4; i++) {
            scene.add(createWesternBuilding(-30 + i * 15));
        }

        // ========== NY FACADES (Simplified) ==========
        function createNYBuilding(z) {
            const group = new THREE.Group();
            const mat = new THREE.MeshLambertMaterial({ color: 0x5a4030 });
            const building = new THREE.Mesh(new THREE.BoxGeometry(10, 16, 2), mat);
            building.position.y = 8;
            building.castShadow = true;
            group.add(building);
            // Windows
            const windowMat = new THREE.MeshBasicMaterial({ color: 0x334455 });
            for (let row = 0; row < 3; row++) {
                for (let col = 0; col < 2; col++) {
                    const w = new THREE.Mesh(new THREE.BoxGeometry(1.8, 2.2, 0.2), windowMat);
                    w.position.set(-2.5 + col * 5, 4 + row * 4, -1.2);
                    group.add(w);
                }
            }
            group.position.set(60, 0, z);
            return group;
        }
        for (let i = 0; i < 3; i++) {
            scene.add(createNYBuilding(-30 + i * 20));
        }

        // ========== PALM TREES (Simplified) ==========
        function createPalmTree(x, z) {
            const group = new THREE.Group();
            const trunk = new THREE.Mesh(
                new THREE.CylinderGeometry(0.25, 0.4, 8, 6),
                new THREE.MeshLambertMaterial({ color: 0x6b5545 })
            );
            trunk.position.y = 4;
            group.add(trunk);
            const frondMat = new THREE.MeshLambertMaterial({ color: 0x228844, side: THREE.DoubleSide });
            for (let i = 0; i < 6; i++) {
                const frond = new THREE.Mesh(new THREE.PlaneGeometry(1.2, 4), frondMat);
                const angle = (i / 6) * Math.PI * 2;
                frond.position.set(Math.cos(angle) * 1.2, 8, Math.sin(angle) * 1.2);
                frond.rotation.x = -0.6;
                frond.rotation.y = angle;
                group.add(frond);
            }
            group.position.set(x, 0, z);
            return group;
        }
        [[-20, -40], [20, -40], [-20, 40], [20, 40], [-60, 0], [0, -60]].forEach(([x, z]) => {
            scene.add(createPalmTree(x, z));
        });

        // ========== COLLECTIBLE STARS (Fewer, simpler) ==========
        const stars = [];
        function createStar(x, z) {
            const group = new THREE.Group();
            const mat = new THREE.MeshBasicMaterial({ color: 0xa78bfa });
            const star = new THREE.Mesh(new THREE.OctahedronGeometry(0.5, 0), mat);
            group.add(star);
            group.position.set(x, 2, z);
            group.userData.collected = false;
            return group;
        }
        const starPositions = [[0, -35], [0, 35], [-35, 0], [35, 0], [-25, -25], [25, -25], [-25, 25], [25, 25]];
        starPositions.forEach(([x, z]) => {
            const star = createStar(x, z);
            stars.push(star);
            scene.add(star);
        });

        // ========== OSCAR TROPHIES (Fewer, simpler) ==========
        const trophies = [];
        function createOscar(x, z) {
            const group = new THREE.Group();
            const mat = new THREE.MeshLambertMaterial({ color: 0xffd700 });
            const base = new THREE.Mesh(new THREE.CylinderGeometry(0.35, 0.4, 0.25, 8), mat);
            group.add(base);
            const body = new THREE.Mesh(new THREE.CylinderGeometry(0.18, 0.25, 1, 8), mat);
            body.position.y = 0.6;
            group.add(body);
            const head = new THREE.Mesh(new THREE.SphereGeometry(0.2, 8, 8), mat);
            head.position.y = 1.3;
            group.add(head);
            group.position.set(x, 1.8, z);
            group.userData.collected = false;
            return group;
        }
        const trophyPositions = [[-45, -45], [45, -45], [-45, 45], [45, 45]];
        trophyPositions.forEach(([x, z]) => {
            const trophy = createOscar(x, z);
            trophies.push(trophy);
            scene.add(trophy);
        });

        // ========== TRAIL PARTICLES (Fewer) ==========
        const trailParticles = [];
        function createTrailParticle(position) {
            const particle = new THREE.Mesh(
                new THREE.SphereGeometry(0.1, 4, 4),
                new THREE.MeshBasicMaterial({ color: 0x8b5cf6, transparent: true, opacity: 0.8 })
            );
            particle.position.copy(position);
            particle.userData.life = 1;
            scene.add(particle);
            trailParticles.push(particle);
            if (trailParticles.length > 30) {
                const old = trailParticles.shift();
                scene.remove(old);
            }
        }

        // ========== PHYSICS & CONTROLS ==========
        const cartState = {
            position: new THREE.Vector3(0, 0, 10),
            velocity: new THREE.Vector3(0, 0, 0),
            rotation: 0,
            angularVelocity: 0,
            maxSpeed: 30,
            acceleration: 18,
            brakeForce: 25,
            friction: 6,
            turnSpeed: 3,
            boost: 100,
            boosting: false
        };

        const keys = { w: false, s: false, a: false, d: false, space: false, r: false };

        document.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            if (key in keys) keys[key] = true;
            if (key === ' ') keys.space = true;
        });

        document.addEventListener('keyup', (e) => {
            const key = e.key.toLowerCase();
            if (key in keys) keys[key] = false;
            if (key === ' ') keys.space = false;
        });

        const speedProgress = document.getElementById('speedProgress');
        const speedValue = document.getElementById('speedValue');
        const boostFill = document.getElementById('boostFill');
        const starsCollectedEl = document.getElementById('starsCollected');
        const trophiesCollectedEl = document.getElementById('trophiesCollected');
        const objectiveFill = document.getElementById('objectiveFill');
        const pickupNotification = document.getElementById('pickupNotification');

        function showPickupNotification(text) {
            pickupNotification.textContent = text;
            pickupNotification.classList.remove('show');
            void pickupNotification.offsetWidth;
            pickupNotification.classList.add('show');
        }

        function updateUI() {
            starsCollectedEl.textContent = `${gameState.starsCollected} / ${gameState.totalStars}`;
            trophiesCollectedEl.textContent = `${gameState.trophiesCollected} / ${gameState.totalTrophies}`;
            const progress = ((gameState.starsCollected + gameState.trophiesCollected) / (gameState.totalStars + gameState.totalTrophies)) * 100;
            objectiveFill.style.width = progress + '%';
        }

        const minimapCanvas = document.getElementById('minimap-canvas');
        const minimapCtx = minimapCanvas.getContext('2d');
        minimapCanvas.width = 120;
        minimapCanvas.height = 120;

        let minimapFrame = 0;
        function updateMinimap() {
            minimapFrame++;
            if (minimapFrame % 3 !== 0) return; // Update less frequently

            minimapCtx.fillStyle = 'rgba(10, 6, 18, 0.95)';
            minimapCtx.fillRect(0, 0, 120, 120);

            // Roads
            minimapCtx.strokeStyle = 'rgba(139, 92, 246, 0.4)';
            minimapCtx.lineWidth = 3;
            minimapCtx.beginPath();
            minimapCtx.moveTo(60, 0);
            minimapCtx.lineTo(60, 120);
            minimapCtx.moveTo(0, 60);
            minimapCtx.lineTo(120, 60);
            minimapCtx.stroke();

            // Collectibles
            stars.forEach(star => {
                if (!star.userData.collected) {
                    const x = 60 + (star.position.x / 70) * 55;
                    const y = 60 + (star.position.z / 70) * 55;
                    minimapCtx.fillStyle = '#a78bfa';
                    minimapCtx.beginPath();
                    minimapCtx.arc(x, y, 3, 0, Math.PI * 2);
                    minimapCtx.fill();
                }
            });

            trophies.forEach(trophy => {
                if (!trophy.userData.collected) {
                    const x = 60 + (trophy.position.x / 70) * 55;
                    const y = 60 + (trophy.position.z / 70) * 55;
                    minimapCtx.fillStyle = '#ffd700';
                    minimapCtx.beginPath();
                    minimapCtx.arc(x, y, 4, 0, Math.PI * 2);
                    minimapCtx.fill();
                }
            });

            // Player
            const playerX = 60 + (cartState.position.x / 70) * 55;
            const playerY = 60 + (cartState.position.z / 70) * 55;
            minimapCtx.save();
            minimapCtx.translate(playerX, playerY);
            minimapCtx.rotate(cartState.rotation);
            minimapCtx.fillStyle = '#8b5cf6';
            minimapCtx.beginPath();
            minimapCtx.moveTo(0, -6);
            minimapCtx.lineTo(-4, 4);
            minimapCtx.lineTo(4, 4);
            minimapCtx.closePath();
            minimapCtx.fill();
            minimapCtx.restore();
        }

        function checkCollisions() {
            const pos = cartState.position;

            stars.forEach(star => {
                if (!star.userData.collected && pos.distanceTo(star.position) < 2.5) {
                    star.userData.collected = true;
                    scene.remove(star);
                    gameState.starsCollected++;
                    showPickupNotification('+1 Star!');
                    updateUI();
                }
            });

            trophies.forEach(trophy => {
                if (!trophy.userData.collected && pos.distanceTo(trophy.position) < 2.5) {
                    trophy.userData.collected = true;
                    scene.remove(trophy);
                    gameState.trophiesCollected++;
                    showPickupNotification('+1 Oscar!');
                    updateUI();
                }
            });
        }

        const clock = new THREE.Clock();
        let lastTime = 0;

        function animate() {
            const currentTime = clock.getElapsedTime();
            const deltaTime = Math.min(currentTime - lastTime, 0.1);
            lastTime = currentTime;

            if (keys.r) {
                cartState.position.set(0, 0, 10);
                cartState.velocity.set(0, 0, 0);
                cartState.rotation = 0;
                cartState.angularVelocity = 0;
            }

            if (keys.space && cartState.boost > 0) {
                cartState.boosting = true;
                cartState.boost -= deltaTime * 25;
                if (cartState.velocity.length() > 8) {
                    createTrailParticle(cartState.position.clone().setY(0.3));
                }
            } else {
                cartState.boosting = false;
                cartState.boost = Math.min(100, cartState.boost + deltaTime * 20);
            }
            boostFill.style.width = cartState.boost + '%';

            const currentMaxSpeed = cartState.boosting ? cartState.maxSpeed * 1.6 : cartState.maxSpeed;
            const currentAccel = cartState.boosting ? cartState.acceleration * 1.5 : cartState.acceleration;

            let accelerating = false, braking = false;

            if (keys.w) {
                accelerating = true;
                const dir = new THREE.Vector3(0, 0, -1).applyAxisAngle(new THREE.Vector3(0, 1, 0), cartState.rotation);
                cartState.velocity.add(dir.multiplyScalar(currentAccel * deltaTime));
            }

            if (keys.s) {
                braking = true;
                const dir = new THREE.Vector3(0, 0, 1).applyAxisAngle(new THREE.Vector3(0, 1, 0), cartState.rotation);
                cartState.velocity.add(dir.multiplyScalar(cartState.brakeForce * deltaTime));
            }

            const speed = cartState.velocity.length();
            if (speed > 0.5) {
                const turnAmount = cartState.turnSpeed * deltaTime * Math.min(1, speed / 10);
                if (keys.a) cartState.angularVelocity += turnAmount;
                if (keys.d) cartState.angularVelocity -= turnAmount;
            }

            if (!accelerating && !braking) {
                const friction = cartState.velocity.clone().normalize().multiplyScalar(-cartState.friction * deltaTime);
                if (friction.length() < cartState.velocity.length()) {
                    cartState.velocity.add(friction);
                } else {
                    cartState.velocity.set(0, 0, 0);
                }
            }

            cartState.angularVelocity *= 0.9;

            if (cartState.velocity.length() > currentMaxSpeed) {
                cartState.velocity.normalize().multiplyScalar(currentMaxSpeed);
            }

            cartState.position.add(cartState.velocity.clone().multiplyScalar(deltaTime));
            cartState.rotation += cartState.angularVelocity;

            const boundary = 65;
            cartState.position.x = Math.max(-boundary, Math.min(boundary, cartState.position.x));
            cartState.position.z = Math.max(-boundary, Math.min(boundary, cartState.position.z));

            cartGroup.position.copy(cartState.position);
            cartGroup.rotation.y = cartState.rotation;

            wheels.forEach(wheel => wheel.rotation.x += speed * deltaTime * 4);

            const targetCameraPos = cartState.position.clone()
                .add(cameraOffset.clone().applyAxisAngle(new THREE.Vector3(0, 1, 0), cartState.rotation));
            camera.position.lerp(targetCameraPos, 0.06);
            camera.lookAt(cartState.position.clone().add(cameraLookOffset));

            speedValue.textContent = Math.round(speed * 2.2);
            speedProgress.style.strokeDashoffset = 251 - (speed / currentMaxSpeed) * 251;

            // Animate collectibles
            stars.forEach((star, i) => {
                if (!star.userData.collected) {
                    star.rotation.y = currentTime * 2 + i;
                    star.position.y = 2 + Math.sin(currentTime * 2 + i) * 0.3;
                }
            });

            trophies.forEach((trophy, i) => {
                if (!trophy.userData.collected) {
                    trophy.rotation.y = currentTime * 1.5 + i;
                    trophy.position.y = 1.8 + Math.sin(currentTime * 1.5 + i) * 0.2;
                }
            });

            // Trail particles
            for (let i = trailParticles.length - 1; i >= 0; i--) {
                const p = trailParticles[i];
                p.userData.life -= deltaTime * 3;
                p.material.opacity = p.userData.life;
                p.scale.setScalar(p.userData.life);
                if (p.userData.life <= 0) {
                    scene.remove(p);
                    trailParticles.splice(i, 1);
                }
            }

            glowLight.intensity = cartState.boosting ? 2 + Math.sin(currentTime * 20) : 1;

            checkCollisions();
            updateMinimap();

            renderer.render(scene, camera);
            requestAnimationFrame(animate);
        }

        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Navigation Menu Toggle
        const navToggle = document.getElementById('navToggle');
        const navMenu = document.getElementById('navMenu');
        const navOverlay = document.getElementById('navOverlay');

        function toggleNav() {
            navToggle.classList.toggle('active');
            navMenu.classList.toggle('open');
            navOverlay.classList.toggle('visible');
        }

        navToggle.addEventListener('click', toggleNav);
        navOverlay.addEventListener('click', toggleNav);

        // Close menu on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && navMenu.classList.contains('open')) {
                toggleNav();
            }
        });
    </script>
</body>
</html>
